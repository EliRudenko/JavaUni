####################################################################
# РЕАЛИЗАЦИЯ ТЕМЫ ВОПРОС 01: Загальна характеристика мови програмування Python
# РЕАЛИЗАЦИЯ ТЕМЫ ВОПРОС 21: Робота серверів у режимі CGI (Common Gateway Interface)
# РЕАЛИЗАЦИЯ ТЕМЫ ВОПРОС 22: CGI: загальний огляд технології, сфери використання, переваги, недоліки
# РЕАЛИЗАЦИЯ ТЕМЫ ВОПРОС 23: CGI: налаштування сервера для запуску Python-скриптів, вимоги до скриптів
# РЕАЛИЗАЦИЯ ТЕМЫ ВОПРОС 24: CGI: взаємодія з оточенням (environment)
# РЕАЛИЗАЦИЯ ТЕМЫ ВОПРОС 25: CGI: стандартні потоки вводу/виводу та кодування
####################################################################

# КЛЮЧЕВЫЕ МОМЕНТЫ ПО ТЕМАМ (КАПСОМ ДЛЯ БЫСТРОГО ПОИСКА):
# - ВОПРОС 01: ИНТЕРПРЕТИРУЕМОСТЬ ВИДНА ПО CGI-SHEBANG И ЗАПУСКУ СКРИПТА СЕРВЕРОМ.
# - ВОПРОС 21: CGI-СКРИПТ ФОРМИРУЕТ HTTP-ЗАГОЛОВКИ И ТЕЛО ОТВЕТА ЧЕРЕЗ STDOUT.
# - ВОПРОС 22: ФАЙЛ ПОКАЗЫВАЕТ СТРУКТУРУ ПРОСТОГО CGI-ОТВЕТА (HTML + ЗАГОЛОВКИ).
# - ВОПРОС 23: СООТВЕТСТВИЕ CGI-ТРЕБОВАНИЯМ — СКРИПТ ВЫДАЕТ ЗАГОЛОВКИ И РАБОТАЕТ ЧЕРЕЗ ИНТЕРПРЕТАТОР.
# - ВОПРОС 24: ИСПОЛЬЗУЕТСЯ OS.ENVIRON ДЛЯ ДОСТУПА К ПЕРЕМЕННЫМ ОКРУЖЕНИЯ.
# - ВОПРОС 25: RECONFIGURE STDOUT НА UTF-8 ПОКАЗЫВАЕТ РАБОТУ СО СТАНДАРТНЫМИ ПОТОКАМИ.
#


# Шебанг вказує інтерпретатор Python для CGI.
# Це вимога CGI: сервер запускає саме цей інтерпретатор для скрипта.
#!C:/Users/morri/AppData/Local/Programs/Python/Python313/python.exe

# os потрібен для доступу до змінних оточення (CGI-параметри).
import os
# sys потрібен для налаштування stdout та виводу байтів.
import sys

# Перемикаємо кодування stdout, щоб коректно віддавати UTF-8.
# У CGI відповідь формуємо через stdout, тому кодування критичне.
sys.stdout.reconfigure(encoding='utf-8')

# CGI передає параметри запиту через змінні оточення.
# Тут ми просто виводимо все оточення, щоб показати, які дані сервер передає скрипту.
sorted_envs = sorted(os.environ.items(), key=lambda item: item[0])

# Формуємо HTML-таблицю зі змінних оточення.
# Це демонструє CGI-дані: REQUEST_METHOD, QUERY_STRING, REMOTE_ADDR тощо.
table_rows = "".join(f"<tr><td>{k}</td><td>{v}</td></tr>\n" for k, v in sorted_envs)
envs_table = f"""
<table border="1" cellpadding="5" cellspacing="0">
    <thead>
        <tr>
            <th>Параметр</th>
            <th>Значення</th>
        </tr>
    </thead>
    <tbody>
        {table_rows}
    </tbody>
</table>
"""

# Повний HTML-документ як рядок.
# CGI не використовує шаблонізатори "за замовчуванням", тому тут ручна генерація.
html = f'''
<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python-CGI</title>
    <link rel="icon" href="/python.png" />
</head>
<body>
<h1>Змінні оточення</h1>
<p>Згідно з принципами CGI всі параметри від сервера до скрипту передаються як змінні оточення</p>
{envs_table}
</body>
</html>
'''

# CGI-відповідь складається з HTTP-заголовків + порожній рядок + тіло.
# Важливо: заголовки пишуться у stdout ДО тіла відповіді.
print("Content-Type: text/html; charset=utf-8\n")  # Заголовок типу контенту.
print("Content-Length:", len(html.encode('utf-8')))  # Довжина відповіді.
print()  # Порожній рядок відділяє заголовки від тіла.
print(html)  # Тіло відповіді.
